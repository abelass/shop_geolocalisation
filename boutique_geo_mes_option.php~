<?php

// redirection selon la lngue du pays


// si pas de cookie langue
	
if(!$cookie_lang=$_COOKIE['spip_lang']{

	include_spip('inc/correspondances');

	$ip =$_SERVER['REMOTE_ADDR'];

	//$ip='92.168.100.0';
	
	//On détermine le pays

	$a=get_country_by_ip($ip);
	preg_match("/\((.*?)\)/",$a['Country'],$match);
	$pays= $match[1];

	//On cherche la langue correpondante
	$langues=pays_langue();
	$langue = $langues[$pays];
	
	//Si on ne trouve pas de correpondance on prend la langue par defaut
	if(!$langue ) $langue =lire_config('langue_site');
				
	$self= self();	

	//Si on ne trouve pas de correpondance on prend la langue par defaut
	include_spip('inc/cookie');
	spip_setcookie('spip_lang', $langue,time()+52*40*3600);	
	
	// Si on a réussi à poser un cookie on renvoie
		
	if($_COOKIE['spip_lang']){
		$destination = parametre_url($self,'lang',$langue,'&');
		include_spip('inc/headers');
		redirige_par_entete($destination);
	}

	}


// ip location


function get_country_by_ip($ip)
{

	$url='http://api.hostip.info/get_html.php?ip='.$ip.'&position=true';
 
	$data=file_get_contents($url);

	$a=array();
	$keys=array('Country','City','Latitude','Longitude','IP');
	$keycount=count($keys);
	for ($r=0; $r < $keycount ; $r++)
	{
		$sstr= substr ($data, strpos($data, $keys[$r]), strlen($data));
		if ( $r < ($keycount-1))
			$sstr = substr ($sstr, 0, strpos($sstr,$keys[$r+1]));
		$s=explode (':',$sstr);
		$a[$keys[$r]] = trim($s[1]);
	}
 
	return $a;
 
}
?>